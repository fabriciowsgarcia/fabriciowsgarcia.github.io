<!DOCTYPE html>
<html lang="pt-BR" class="">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proje√ß√£o Financeira V2.0</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para os gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    .editable-cell input { background: transparent; border: 1px solid transparent; padding: 0; text-align: right; width: 100%; min-width: 60px; box-sizing: border-box; transition: border-color 0.2s; }
    .editable-cell input:focus { outline: none; border-color: #a78bfa; }
    #app-container.disabled, #app-container.loading { opacity: 0.5; pointer-events: none; }
    /* Estilos para o Modo Escuro */
    .dark body { background-color: #111827; color: #d1d5db; }
    .dark .bg-white { background-color: #1f2937; border-color: #4b5563; }
    .dark .bg-gray-50 { background-color: #374151; }
    .dark .bg-purple-50 { background-color: #3730a3; border-color: #4338ca; }
    .dark .text-gray-800, .dark .text-gray-700, .dark .text-gray-900 { color: #f9fafb; }
    .dark .text-gray-500, .dark .text-gray-600 { color: #9ca3af; }
    .dark .border, .dark .divide-y, .dark .border-b, .dark .border-r { border-color: #4b5563 !important; }
    .dark input, .dark select { background-color: #374151; color: #f9fafb; border-color: #4b5563; }
    .dark .editable-cell input:focus { background-color: #4b5563; }
    .dark .bg-purple-100 { background-color: #312e81; }
    .dark .bg-green-100 { background-color: #047857; }
    .dark .bg-green-50 { background-color: #064e3b; border-color: #059669; }
    .dark .text-purple-800 { color: #a78bfa; }
    .dark .text-blue-600 { color: #60a5fa; }
    .dark .text-green-600 { color: #34d399; }
    .dark .text-green-700 { color: #6ee7b7; }
    .dark .text-orange-700 { color: #fb923c; }
  </style>
</head>

<body class="min-h-screen p-4 sm:p-8">
  <div class="max-w-7xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-xl border border-gray-200">
    
    <!-- CABE√áALHO E LOGIN -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
        <div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center sm:text-left text-purple-800">Proje√ß√£o Financeira</h1>
            <p class="text-center sm:text-left text-gray-500">Sincronizada na nuvem com Firebase.</p>
        </div>
        <div class="flex items-center gap-4 mt-4 sm:mt-0">
            <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800">üåô</button>
            <div id="auth-container"></div>
        </div>
    </div>
    
    <div id="app-container" class="disabled">
        <!-- PAINEL DE CONTROLE -->
        <div class="space-y-6 bg-purple-50 p-6 rounded-2xl shadow-inner border border-purple-200 mb-8">
          <!-- ... (sec√ß√µes de Bancos e Configura√ß√µes Gerais) ... -->
        </div>

        <!-- GR√ÅFICO E EVENTOS -->
        <div class="space-y-8 mb-8">
            <div>
                <h2 class="text-2xl font-bold mb-4 text-purple-800">Evolu√ß√£o do Patrim√≥nio</h2>
                <div class="bg-white p-4 rounded-xl shadow-lg border">
                    <canvas id="evolution-chart"></canvas>
                </div>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-4 text-purple-800">Eventos Financeiros</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg border space-y-4">
                    <div id="events-container" class="space-y-3"></div>
                    <button id="add-event-button" class="mt-2 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow hover:bg-purple-700 transition duration-300">+ Adicionar Evento</button>
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
          <button id="recalculate-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-purple-600 text-white font-bold rounded-full shadow-lg hover:bg-purple-700 transition duration-300 text-lg">Recalcular</button>
          <button id="save-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-gray-500 text-white font-bold rounded-full shadow-lg hover:bg-gray-600 transition duration-300 text-lg">Salvar na Nuvem</button>
          <button id="export-csv-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 text-lg">Exportar CSV</button>
          <button id="reset-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600 transition duration-300 text-lg">Resetar</button>
        </div>

        <div id="status-message" class="text-center text-sm font-medium text-gray-600 mb-4"></div>

        <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-300">
          <table class="min-w-full divide-y divide-gray-300 bg-white">
            <thead id="projection-table-head" class="bg-purple-100"></thead>
            <tbody id="projection-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center bg-green-50 p-6 rounded-2xl shadow-inner border border-green-200">
            <div class="text-center text-lg sm:text-xl font-bold">
              <p class="text-gray-700" id="final-summary"></p>
            </div>
            <div class="w-full max-w-sm mx-auto">
                <canvas id="summary-pie-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-10 text-sm text-gray-500">
      <p>Powered by: Fabr√≠cio Garcia</p>
    </div>
  </div>

  <!-- FIREBASE SDKs e L√ìGICA DA APLICA√á√ÉO -->
  <script type="module">
    // ... (todo o c√≥digo JavaScript atualizado, incluindo as novas funcionalidades)
    // Importa√ß√µes do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCxCoLySMztPI2ZEirFIX8lzTziytdAtLw",
      authDomain: "projecao-financeira-app.firebaseapp.com",
      projectId: "projecao-financeira-app",
      storageBucket: "projecao-financeira-app.firebasestorage.app",
      messagingSenderId: "761180323629",
      appId: "1:761180323629:web:9d6945b83554f3ce9b9da4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- ESTADO DA APLICA√á√ÉO ---
    let state = {};
    let tableInputData = [];
    let currentUser = null;
    let evolutionChartInstance = null;
    let summaryPieChartInstance = null;

    function getDefaultState() {
        return {
            banks: [{ id: Date.now(), name: 'Exemplo', balance: 50000, yieldRate: 1.0, limit: null }],
            events: [],
            general: {
                totalGoal: 1000000,
                defaultContribution: 6000,
                startDate: new Date().toISOString().slice(0, 7),
                showUntilGoal: false,
                darkMode: false
            }
        };
    }
    
    // --- L√ìGICA PRINCIPAL ---
    
    function renderApp() {
        renderBankInputs();
        renderGeneralInputs();
        renderEvents();
        renderTableAndCharts();
        updateTheme();
    }

    function renderTableAndCharts() {
        if (!currentUser) return;
        const projection = calculateProjection();
        renderTable(projection);
        renderEvolutionChart(projection);
        renderSummaryChart(projection);
    }
    
    function updateTheme() {
        if (state.general.darkMode) {
            document.documentElement.classList.add('dark');
            document.getElementById('dark-mode-toggle').textContent = '‚òÄÔ∏è';
        } else {
            document.documentElement.classList.remove('dark');
            document.getElementById('dark-mode-toggle').textContent = 'üåô';
        }
    }

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO (Bancos, Geral, Eventos) ---
    function renderBankInputs() { /* ... */ }
    function renderGeneralInputs() { /* ... */ }
    
    function renderEvents() {
        const container = document.getElementById('events-container');
        const bankOptions = state.banks.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        container.innerHTML = state.events.map((event, index) => `
            <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border">
                <select data-index="${index}" data-field="type" class="event-input border-gray-300 rounded-md">
                    <option value="deposit" ${event.type === 'deposit' ? 'selected' : ''}>Aporte Extra</option>
                    <option value="withdrawal" ${event.type === 'withdrawal' ? 'selected' : ''}>Retirada</option>
                    <option value="contribution_change" ${event.type === 'contribution_change' ? 'selected' : ''}>Mudar Aporte Padr√£o</option>
                </select>
                <input type="month" value="${event.date}" data-index="${index}" data-field="date" class="event-input border-gray-300 rounded-md">
                <input type="number" value="${event.amount}" data-index="${index}" data-field="amount" placeholder="Valor" class="event-input text-right border-gray-300 rounded-md">
                <select data-index="${index}" data-field="bankId" class="event-input border-gray-300 rounded-md ${event.type === 'contribution_change' ? 'hidden' : ''}">
                    ${bankOptions}
                </select>
                <button data-index="${index}" class="remove-event-button flex justify-center items-center bg-red-500 text-white rounded-md hover:bg-red-600 p-2">- Remover</button>
            </div>
        `).join('');
    }

    // --- FUN√á√ïES DE GR√ÅFICOS (Chart.js) ---
    function renderEvolutionChart(projection) { /* ... */ }
    function renderSummaryChart(projection) { /* ... */ }

    // --- L√ìGICA DE C√ÅLCULO ATUALIZADA ---
    function calculateProjection() {
        let balances = state.banks.map(b => b.balance);
        let currentDefaultContribution = state.general.defaultContribution;
        let totalContributed = state.banks.reduce((sum, b) => sum + b.balance, 0);
        let totalInterest = 0;
        
        let startDate = state.general.startDate ? new Date(state.general.startDate.split('-')[0], state.general.startDate.split('-')[1] - 1, 1) : new Date();
        startDate.setDate(1);
        let currentDate = new Date(startDate.getTime());
        
        const sortedEvents = [...state.events].sort((a, b) => new Date(a.date) - new Date(b.date));

        const results = [];
        let goalReached = false, goalInfo = {}, totalMonthsToGoal = 600;

        for (let i = 0; i < 600; i++) {
            const monthStr = currentDate.toISOString().slice(0, 7);
            
            // Aplicar eventos para o m√™s atual
            sortedEvents.filter(e => e.date === monthStr).forEach(event => {
                if (event.type === 'deposit') {
                    const bankIndex = state.banks.findIndex(b => b.id == event.bankId);
                    if (bankIndex !== -1) {
                        balances[bankIndex] += event.amount;
                        totalContributed += event.amount;
                    }
                } else if (event.type === 'withdrawal') {
                    const bankIndex = state.banks.findIndex(b => b.id == event.bankId);
                    if (bankIndex !== -1) {
                        balances[bankIndex] -= event.amount;
                        totalContributed -= event.amount; // Retirada diminui o capital aportado
                    }
                } else if (event.type === 'contribution_change') {
                    currentDefaultContribution = event.amount;
                }
            });

            // L√≥gica de aporte mensal padr√£o
            let monthlyContribution = currentDefaultContribution;
            let contributionApplied = false;
            // ... (l√≥gica de aporte padr√£o) ...
            
            totalContributed += monthlyContribution;

            // ... (l√≥gica de c√°lculo de rendimento) ...
            let monthInterest = 0;
            // ...
            totalInterest += monthInterest;
            
            // ... (resto da l√≥gica de c√°lculo) ...
        }

        return { /* ... results, goalInfo, etc ... */ totalContributed, totalInterest };
    }

    // --- FUN√á√ïES DE DADOS (Firebase) e Usabilidade ---
    async function loadState() { /* ... */ }
    function updateStateFromInputs() { /* ... */ }
    async function saveState() { /* ... */ }
    function resetToDefault(confirmReset = true) { /* ... */ }
    function exportToCSV() { /* ... */ }

    // --- INICIALIZA√á√ÉO E BINDING DE EVENTOS ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... (c√≥digo de inicializa√ß√£o e todos os event listeners para os novos bot√µes)
    });
    
  </script>
</body>
</html>

