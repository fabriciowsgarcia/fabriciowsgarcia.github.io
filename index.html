<!DOCTYPE html>
<html lang="pt-BR" class="">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net/npm/chart.js https://www.gstatic.com https://*.firebaseio.com https://www.googleapis.com https://identitytoolkit.googleapis.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' wss://*.firebaseio.com https://*.googleapis.com; frame-src https://projecao-financeira-app.firebaseapp.com; object-src 'none'; base-uri 'self';">
  <title>Projeção Financeira VGrafico</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para os gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    .editable-cell input { background: transparent; border: 1px solid transparent; padding: 0; text-align: right; width: 100%; min-width: 60px; box-sizing: border-box; transition: border-color 0.2s; }
    .editable-cell input:focus { outline: none; border-color: #a78bfa; }
    #app-container.disabled, #app-container.loading { opacity: 0.5; pointer-events: none; }
  </style>
</head>

<body class="min-h-screen p-4 sm:p-8 bg-gray-50">
  <div class="max-w-7xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-xl border border-gray-200">
    
    <!-- CABEÇALHO E LOGIN -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
        <div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center sm:text-left text-purple-800">Projeção Financeira</h1>
            <p class="text-center sm:text-left text-gray-500">Sincronizada na nuvem com Firebase.</p>
        </div>
        <div id="auth-container" class="mt-4 sm:mt-0"></div>
    </div>
    
    <div id="app-container" class="disabled">
        <!-- PAINEL DE CONTROLE -->
        <div class="space-y-6 bg-purple-50 p-6 rounded-2xl shadow-inner border border-purple-200 mb-8">
          <div>
            <h2 class="text-xl font-bold mb-3 text-purple-800">Bancos e Contas</h2>
            <div id="banks-container" class="space-y-3"></div>
            <button id="add-bank-button" class="mt-4 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow hover:bg-purple-700 transition duration-300">+ Adicionar Banco</button>
          </div>
          <div>
            <h2 class="text-xl font-bold mb-3 text-purple-800">Configurações Gerais</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="flex flex-col p-4 bg-white rounded-lg border">
                <label for="total-goal" class="text-sm font-semibold text-gray-600 mb-1">Meta Financeira:</label>
                <div class="flex items-center">
                  <span class="text-lg font-bold text-blue-600">R$</span>
                  <input type="number" id="total-goal" value="1000000.00" class="text-lg font-bold text-blue-600 text-left bg-transparent border-none focus:outline-none w-full">
                </div>
              </div>
              <div class="flex flex-col p-4 bg-white rounded-lg border">
                <label for="default-contribution" class="text-sm font-semibold text-gray-600 mb-1">Aporte Mensal Padrão:</label>
                <div class="flex items-center">
                  <span class="text-lg font-bold text-green-600">R$</span>
                  <input type="number" id="default-contribution" value="6000.00" class="text-lg font-bold text-green-600 text-left bg-transparent border-none focus:outline-none w-full">
                </div>
              </div>
              <div class="flex flex-col p-4 bg-white rounded-lg border">
                <label for="projection-start-date" class="text-sm font-semibold text-gray-600 mb-1">Início da Projeção:</label>
                <input type="month" id="projection-start-date" class="text-lg font-bold text-gray-700 bg-transparent border-none focus:outline-none w-full">
              </div>
            </div>
          </div>
        </div>

        <!-- GRÁFICO DE EVOLUÇÃO -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4 text-purple-800">Evolução do Património</h2>
            <div class="bg-white p-4 rounded-xl shadow-lg border">
                <canvas id="evolution-chart"></canvas>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row flex-wrap gap-4 mb-8">
          <button id="recalculate-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-purple-600 text-white font-bold rounded-full shadow-lg hover:bg-purple-700 transition duration-300 text-lg">Recalcular</button>
          <button id="save-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-gray-500 text-white font-bold rounded-full shadow-lg hover:bg-gray-600 transition duration-300 text-lg">Salvar na Nuvem</button>
          <button id="reset-button" class="w-full sm:w-auto flex-grow flex items-center justify-center gap-2 px-8 py-4 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600 transition duration-300 text-lg">Resetar</button>
        </div>

        <div id="status-message" class="text-center text-sm font-medium text-gray-600 mb-4"></div>

        <div class="overflow-x-auto rounded-xl shadow-lg border border-gray-300">
          <table class="min-w-full divide-y divide-gray-300 bg-white">
            <thead id="projection-table-head" class="bg-purple-100"></thead>
            <tbody id="projection-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8 items-center bg-green-50 p-6 rounded-2xl shadow-inner border border-green-200">
            <div class="text-center text-lg sm:text-xl font-bold">
              <p class="text-gray-700" id="final-summary"></p>
              <div id="summary-details" class="mt-4 text-base font-normal"></div>
            </div>
            <div class="w-full max-w-sm mx-auto">
                <canvas id="summary-pie-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-10 text-sm text-gray-500">
      <p>Powered by: Fabrício Garcia</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCxCoLySMztPI2ZEirFIX8lzTziytdAtLw",
      authDomain: "projecao-financeira-app.firebaseapp.com",
      projectId: "projecao-financeira-app",
      storageBucket: "projecao-financeira-app.firebasestorage.app",
      messagingSenderId: "761180323629",
      appId: "1:761180323629:web:9d6945b83554f3ce9b9da4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let state = {};
    let currentUser = null;
    let evolutionChartInstance = null;
    let summaryPieChartInstance = null;

    function getDefaultState() {
        return {
            banks: [{ id: Date.now(), name: 'Exemplo', balance: 50000, yieldRate: 1.0, limit: null }],
            general: {
                totalGoal: 1000000,
                defaultContribution: 6000,
                startDate: new Date().toISOString().slice(0, 7)
            }
        };
    }
    
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');

    function renderApp() {
        renderBankInputs();
        renderGeneralInputs();
        renderTableAndCharts();
    }

    function renderTableAndCharts() {
        if (!currentUser) return;
        const projection = calculateProjection();
        renderTable(projection);
        renderEvolutionChart(projection);
        renderSummaryChart(projection);
    }
    
    function renderBankInputs() {
        const container = document.getElementById('banks-container');
        container.innerHTML = (state.banks || []).map((bank) => `
            <div class="bank-entry grid grid-cols-1 md:grid-cols-5 gap-2 items-center p-3 bg-white rounded-lg border" data-id="${bank.id}">
                <input type="text" value="${bank.name}" data-field="name" class="bank-input col-span-1 border-gray-300 rounded-md">
                <input type="number" value="${bank.balance}" data-field="balance" class="bank-input text-right border-gray-300 rounded-md">
                <input type="number" value="${bank.yieldRate}" data-field="yieldRate" class="bank-input text-right border-gray-300 rounded-md">
                <input type="number" value="${bank.limit || ''}" data-field="limit" placeholder="Opcional" class="bank-input text-right border-gray-300 rounded-md">
                <button data-id="${bank.id}" class="remove-bank-button flex justify-center items-center bg-red-500 text-white rounded-md hover:bg-red-600 p-2">- Remover</button>
            </div>
        `).join('');
    }

    function renderGeneralInputs() {
        document.getElementById('total-goal').value = state.general.totalGoal;
        document.getElementById('default-contribution').value = state.general.defaultContribution;
        document.getElementById('projection-start-date').value = state.general.startDate || '';
    }
    
    function renderTable(projection) {
        const tbody = document.getElementById('projection-table-body');
        const finalSummary = document.getElementById('final-summary');
        const summaryDetails = document.getElementById('summary-details');

        tbody.innerHTML = projection.results.map(month => {
            let rowHtml = `<tr class="${month.isGoalMonth ? 'bg-green-100' : ''}">
                <td class="px-3 py-3 text-sm text-center border-r">${month.date}</td>`;
            
            month.banks.forEach(bankData => {
                rowHtml += `
                    <td class="px-3 py-3 text-sm text-right border-r">${formatCurrency(bankData.startBalance)}</td>
                    <td class="px-3 py-3 text-sm text-right border-r text-green-600">${formatCurrency(bankData.contribution)}</td>
                    <td class="px-3 py-3 text-sm text-right border-r text-purple-600">${bankData.yieldRate.toFixed(2)}%</td>
                    <td class="px-3 py-3 text-sm text-right font-bold border-r">${formatCurrency(bankData.endBalance)}</td>
                `;
            });

            rowHtml += `<td class="px-3 py-3 text-sm text-right font-extrabold">${formatCurrency(month.totalBalance)}</td></tr>`;
            return rowHtml;
        }).join('');

        if (projection.goalReached) {
            const { years, months, finalTotal } = projection.goalInfo;
            finalSummary.innerHTML = `Meta atingida em <span class="text-green-700">${years} anos e ${months} meses</span>.<br>Saldo total: <span class="text-green-700">${formatCurrency(finalTotal)}</span>`;
            summaryDetails.innerHTML = `
                <p>Total Aportado: <span class="font-semibold">${formatCurrency(projection.totalContributed)}</span></p>
                <p>Juros Ganhos: <span class="font-semibold">${formatCurrency(projection.totalInterest)}</span></p>
            `;
        } else {
            const finalTotal = projection.results.length > 0 ? projection.results.slice(-1)[0].totalBalance : 0;
            finalSummary.innerHTML = `Meta não atingida.<br>Saldo final projetado: <span class="text-orange-700">${formatCurrency(finalTotal)}</span>`;
            summaryDetails.innerHTML = '';
        }
    }
    
    function renderEvolutionChart(projection) {
        const ctx = document.getElementById('evolution-chart').getContext('2d');
        if (evolutionChartInstance) evolutionChartInstance.destroy();
        evolutionChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: projection.results.map(r => r.date),
                datasets: [{
                    label: 'Património Total',
                    data: projection.results.map(r => r.totalBalance),
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }

    function renderSummaryChart(projection) {
        const ctx = document.getElementById('summary-pie-chart').getContext('2d');
        if (summaryPieChartInstance) summaryPieChartInstance.destroy();

        if (projection.goalReached && projection.totalContributed > 0) {
            summaryPieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Total Aportado', 'Juros Ganhos'],
                    datasets: [{
                        data: [projection.totalContributed, projection.totalInterest],
                        backgroundColor: ['#34d399', '#a78bfa'],
                    }]
                }
            });
        }
    }

    function calculateProjection() {
        let balances = (state.banks || []).map(b => b.balance);
        let totalContributed = (state.banks || []).reduce((sum, b) => sum + b.balance, 0);
        let totalInterest = 0;
        
        let startDate = state.general.startDate ? new Date(state.general.startDate.split('-')[0], state.general.startDate.split('-')[1] - 1, 1) : new Date();
        startDate.setDate(1);
        let currentDate = new Date(startDate.getTime());
        
        const results = [];
        let goalReached = false, goalInfo = {};

        for (let i = 0; i < 600; i++) {
            let monthlyContribution = state.general.defaultContribution;
            let contributionApplied = false;

            let contributionTargetIndex = -1;
            for(let j=0; j < state.banks.length; j++) {
                if(state.banks[j].limit === null || balances[j] < state.banks[j].limit) {
                    contributionTargetIndex = j;
                    break;
                }
            }
            if(contributionTargetIndex === -1 && state.banks.length > 0) {
                contributionTargetIndex = state.banks.length - 1;
            }

            let monthInterest = 0;
            const bankDataForMonth = [];
            (state.banks || []).forEach((bank, j) => {
                const startBalance = balances[j];
                const contribution = (j === contributionTargetIndex) ? monthlyContribution : 0;
                const yieldRate = bank.yieldRate;
                const yieldAmount = (startBalance + contribution) * (yieldRate / 100);
                const endBalance = startBalance + contribution + yieldAmount;
                
                monthInterest += yieldAmount;
                balances[j] = endBalance;
                bankDataForMonth.push({ startBalance, contribution, yieldRate, yieldAmount, endBalance });
            });
            totalContributed += monthlyContribution;
            totalInterest += monthInterest;
            
            const totalBalance = balances.reduce((sum, b) => sum + b, 0);
            
            const monthResult = { date: currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }), banks: bankDataForMonth, totalBalance, isGoalMonth: false };

            if (totalBalance >= state.general.totalGoal && !goalReached) {
                goalReached = true;
                monthResult.isGoalMonth = true;
                const totalMonths = i + 1;
                goalInfo = { years: Math.floor(totalMonths / 12), months: totalMonths % 12, finalTotal: totalBalance };
            }
            results.push(monthResult);
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        return { results, goalReached, goalInfo, totalContributed, totalInterest };
    }

    async function loadState() {
        if (!currentUser) return;
        const docRef = doc(db, "users", currentUser.uid);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                state = { ...getDefaultState(), ...docSnap.data(), general: {...getDefaultState().general, ...docSnap.data().general} };
            } else {
                state = getDefaultState();
            }
        } catch (error) {
            console.error("Erro ao carregar dados:", error);
            state = getDefaultState();
        }
        renderApp();
    }
    
    function updateStateFromInputs() {
        state.general.totalGoal = parseFloat(document.getElementById('total-goal').value) || 0;
        state.general.defaultContribution = parseFloat(document.getElementById('default-contribution').value) || 0;
        state.general.startDate = document.getElementById('projection-start-date').value || '';
        
        const newBanks = [];
        document.querySelectorAll('#banks-container .bank-entry').forEach(el => {
            newBanks.push({
                id: parseInt(el.dataset.id, 10),
                name: el.querySelector('[data-field="name"]').value,
                balance: parseFloat(el.querySelector('[data-field="balance"]').value) || 0,
                yieldRate: parseFloat(el.querySelector('[data-field="yieldRate"]').value) || 0,
                limit: parseFloat(el.querySelector('[data-field="limit"]').value) || null,
            });
        });
        state.banks = newBanks;
    }

    async function saveState() {
        if (!currentUser) return;
        updateStateFromInputs();
        const docRef = doc(db, "users", currentUser.uid);
        const statusMessage = document.getElementById('status-message');
        try {
            statusMessage.textContent = 'Salvando na nuvem...';
            await setDoc(docRef, state);
            statusMessage.textContent = 'Valores salvos com sucesso!';
        } catch (error) {
            console.error("Erro ao salvar:", error);
            statusMessage.textContent = 'Erro ao salvar os dados.';
        }
    }

    function resetToDefault(confirmReset = true) {
        if (confirmReset && !confirm('Tem certeza que deseja resetar?')) return;
        state = getDefaultState();
        renderApp();
        if (currentUser) saveState();
    }
    
    const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;

    document.addEventListener('DOMContentLoaded', () => {
        authContainer.innerHTML = '<p class="text-sm">Verificando...</p>';
        appContainer.classList.add('loading');
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                authContainer.innerHTML = `<div class="text-right"><p class="text-sm">${user.displayName}</p><button id="logout-button" class="text-sm text-purple-600 hover:underline">Sair</button></div>`;
                appContainer.classList.remove('loading', 'disabled');
                loadState();
            } else {
                currentUser = null;
                authContainer.innerHTML = '<button id="login-button" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow">Entrar com Google</button>';
                appContainer.classList.add('disabled');
                appContainer.classList.remove('loading');
                state = getDefaultState();
                renderApp();
            }
        });
        
        authContainer.addEventListener('click', e => {
            if (e.target.id === 'login-button') signInWithPopup(auth, provider).catch(err => console.error("Erro no login:", err));
            if (e.target.id === 'logout-button') signOut(auth).catch(err => console.error("Erro no logout:", err));
        });

        document.getElementById('add-bank-button').addEventListener('click', () => {
            state.banks.push({ id: Date.now(), name: 'Novo Banco', balance: 0, yieldRate: 1.0, limit: null });
            renderApp();
        });
        
        document.getElementById('banks-container').addEventListener('click', e => {
            if (e.target.classList.contains('remove-bank-button')) {
                const bankId = parseInt(e.target.dataset.id, 10);
                state.banks = state.banks.filter(b => b.id !== bankId);
                renderApp();
            }
        });
        
        ['total-goal', 'default-contribution', 'projection-start-date'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderTableAndCharts);
        });
        
        document.getElementById('recalculate-button').addEventListener('click', () => { updateStateFromInputs(); renderTableAndCharts(); });
        document.getElementById('save-button').addEventListener('click', saveState);
        document.getElementById('reset-button').addEventListener('click', () => resetToDefault(true));
    });
  </script>
</body>
</html>

